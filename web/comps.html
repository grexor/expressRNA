<script>
  menu_select("link_search");
</script>

<link rel="stylesheet" href="/tippy/tippy.css">
<script src="/tippy/tippy.min.js"></script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<style>

  .tippy-tooltip.light-theme {
    font-family: 'Open Sans', sans-serif;
    font-size: 13px;
    text-align: justify;
    background-color: #ffffff !important;
  }

  a {
    text-decoration: none;
    color: #2a6bcc;
  }

  a:hover {
    text-decoration: none;
    color: #0D4F8B;
  }

</style>

<script>
  var pair_type = "same_exon";
  var clip_index = "0";
  var go_aspect = "P";
  var comps_data = "";
  $("#link_search").attr('style', 'border-bottom: 2px solid #c1c1c1;');

</script>

<div class="main">

  <div class="main_content">
      <div id="lbl_comps" style="padding-left:20px;"></div>
      <div id="lbl_comps_notes" style="padding-left:20px; font-size:12px;"></div>

      <table border=0 class=apatype_menu>
        <tr>
          <td id="btn_same_exon" onclick="javascript:open_pair_type('same_exon');">
            same-exon
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:5px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_composite_exon" onclick="javascript:open_pair_type('composite_exon');">
            composite-exon
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:5px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_skipped_exon" onclick="javascript:open_pair_type('skipped_exon');">
            skipped-exon
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:5px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_combined_exon" onclick="javascript:open_pair_type('combined_exon');">
            combined
          </td>
          <td style="padding-left: 5px; padding-right: 0px; width:5px; background-color: transparent !important;">
            <font color="darkgreen" class="btn" title="Based on the loci of the proximal and distal polyA sites, this is either:<br><br><img src='docs/media/pair_type.png' width=360><br><br>For details, please see <a href='http://www.cell.com/action/showImagesData?pii=S2211-1247%2817%2930522-3' target=_fig2>Rot et al. (2016), Figure 2</a>."><img src=media/help.png style='height: 15px; margin-top:-2px;vertical-align:middle; padding-left: 3px;'></font>
          </td>
        </tr>
      </table>

      <table border=0>
        <tr>
          <td style="text-align: center;">
            <div id="proximal_title" style="margin: auto; display: inline; font-size: 13px; color: #777777;"></div><div style="display: inline;"><font color="darkgreen" class="btn" title="The plot below shows the <b>percentage of regulated proximal polyA sites with CLIP signal (binding)</b> from the data selected above in the combo box. The <font color=blue>repressed</font> targets binding is shown in blue, and the <font color=red>enhanced</font> targets binding is shown in red."><img src=media/help.png style='height: 15px; margin-top:0px;vertical-align:middle; padding-left: 3px;'></font></div>
            <div id="proximal" style="padding-left:0px; float: left; width:500px; height:150px;"></div>
          </td>
          <td style="text-align: center;">
            <div id="distal_title" style="margin: auto; display: inline; font-size: 13px; color: #777777;"></div><div style="display: inline;"><font color="darkgreen" class="btn" title="The plot below shows the <b>percentage of regulated distal polyA sites with CLIP signal (binding)</b> from the data selected above in the combo box. The <font color=blue>repressed</font> targets binding is shown in blue, and the <font color=red>enhanced</font> targets binding is shown in red."><img src=media/help.png style='height: 15px; margin-top:0px;vertical-align:middle; padding-left: 3px;'></font></div>
            <div id="distal" style="padding-left:0px; float: left; width:500px; height:150px;"></div>
          </td>
        </tr>
      </table>

      <table align=center border=0 class=comps_menu>
        <tr>
          <td id="btn_es" onclick="javascript:open_div('es');">
            <img src="media/icon_es.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            Setup
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_atlas" onclick="javascript:open_div('atlas');">
            <img src="media/icon_atlas.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            Atlas
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_target" onclick="javascript:open_div('target');">
            <img src="media/icon_target.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            Targets
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_splicing" onclick="javascript:open_div('splicing');">
            <img src="media/splicing.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            Splicing
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_rna" onclick="javascript:open_div('rna');">
            <img src="media/icon_rnamotif.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            RNAmotifs2
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_go" onclick="javascript:open_div('go');">
            <img src="media/icon_go.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            GO analysis
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_model" onclick="javascript:open_div('model');">
            <img src="media/icon_model.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            Model
          </td>
          <td style="padding-left: 0px; padding-right: 0px; width:15px; background-color: transparent !important; cursor:default;"></td>
          <td id="btn_download" onclick="javascript:open_div('download');">
            <img src="media/icon_download.png" height=16px style="margin-top:-4px; padding-right: 2px; vertical-align:middle">
            Downloads
          </td>
        </tr>
      </table>

      <div class="div_es" id="div_es">
      </div>

      <div class="div_atlas" id="div_atlas">
        <center>
        Atlas of polyA sites and gene annotation statistics
        <br>
        <img src="" width=800px id="img_atlas">
      </div>

      <div class="div_rna" id="div_rna">
        <center>
        Motif analysis of regulated sites (proximal, distal separatelly) with RNAmotifs2 approach
          <table border=0>
            <tr>
              <td valign=top>
                <iframe id="iframe_proximal" width=500 height=800 frameBorder="0" onload="resize_iframe(this)"></iframe>
              </td>
              <td valign=top>
                <iframe id="iframe_distal" width=500 height=800 frameBorder="0" onload="resize_iframe(this)"></iframe>
              </td>
            </tr>
          </table>
      </div>

      <div class="div_go" id="div_go">
        GO analysis
      </div>

      <div class="div_model" id="div_model">
        <center></center>
      </div>

      <div class="div_splicing" id="div_splicing">
        <br>
        <center>
          RNA-protein binding at splice-sites surrounding regulated proximal and distal polyA sites (look at <b>s1</b> and <b>s2</b> loci in<font color="darkgreen" class="btn" title="Based on the loci of the proximal and distal polyA sites, this is either:<br><br><img src='docs/media/pair_type.png' width=360><br><br>For details, please see <a href='http://www.cell.com/action/showImagesData?pii=S2211-1247%2817%2930522-3' target=_fig2>Rot et al. (2016), Figure 2</a>."><img src=media/help.png style='height: 15px; margin-top:-2px;vertical-align:middle; padding-left: 3px;'></font> figure).
        </center>
        <br>
        <table border=0>
          <tr>
            <td style="text-align: center;">
              <div id="s1_title" style="margin: auto; display: inline; font-size: 13px; color: #777777;"></div><div style="display: inline;"><font color="darkgreen" class="btn" title="The plot below shows the <b>percentage of regulated splice-site 1 with CLIP signal (binding)</b> from the data selected above in the combo box. The <font color=blue>repressed</font> targets binding is shown in blue, and the <font color=red>enhanced</font> targets binding is shown in red."><img src=media/help.png style='height: 15px; margin-top:0px;vertical-align:middle; padding-left: 3px;'></font></div>
              <div id="s1" style="padding-left:0px; padding-top: 0px; float: left; width:500px; height:150px;"></div>
            </td>
            <td style="text-align: center;">
              <div id="s2_title" style="margin: auto; display: inline; font-size: 13px; color: #777777;"></div><div style="display: inline;"><font color="darkgreen" class="btn" title="The plot below shows the <b>percentage of regulated splice-site 2 with CLIP signal (binding)</b> from the data selected above in the combo box. The <font color=blue>repressed</font> targets binding is shown in blue, and the <font color=red>enhanced</font> targets binding is shown in red."><img src=media/help.png style='height: 15px; margin-top:0px;vertical-align:middle; padding-left: 3px;'></font></div>
              <div id="s2" style="float:left; padding-top: 0px; width:500px; height:150px;"></div>
            </td>
          </tr>
        </table>
      </div>

      <div class="div_download" id="div_download">
        <center>
          Downloads of analysis results in tab-delimited or other file formats<br><br>
          <table class='download_table'>
            <tr style='background-color: #dfdfdf;'>
              <td><font color=gray><b>File</b></font></td><td><font color=gray><b>Description</b></font></td><td><font color=gray><b>Link</b></font></td>
            </tr>
            <tr>
              <td class='nowrap'><img src=media/right_empty.png height=8 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>differential expression (polyA site level)</td><td class='notes'>differentially polyadenylated (apa) genes with 2 polyA sites per gene (proximal, distal)</td><td class='nowrap'><a id=link_download1 target="_download1" download><img src=media/icon_download_small.png height=10 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>Download</a></td>
            </tr>
            <tr>
              <td class='nowrap'><img src=media/right_empty.png height=8 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>differential expression (gene level)</td><td class='notes'>differentially expressed genes: we compute gene expression based on sum of polyA sites expression for each gene and test for differential expression with edgeR</td><td class='nowrap'><a id=link_download2 target="_download2" download><img src=media/icon_download_small.png height=10 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>Download</a></td>
            </tr>
            <tr>
              <td class='nowrap'><img src=media/right_empty.png height=8 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>expression table (polyA sites)</td><td class='notes'>expression values per polyA site for each of the comparison experiments</td><td class='nowrap'><a id=link_download3 target="_download3" download><img src=media/icon_download_small.png height=10 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>Download</a></td>
            </tr>
            <tr>
              <td class='nowrap'><img src=media/right_empty.png height=8 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>expression table (genes)</td><td class='notes'>expression values per gene for each of the comparison experiments</td><td class='nowrap'><a id=link_download4 target="_download4" download><img src=media/icon_download_small.png height=10 style='padding-right:3px; margin-top:-2px;vertical-align:middle'>Download</a></td>
            </tr>
          </table>
      </div>

      <div class="div_target" id="div_target">
        <center>
          Target genes represented with heatmaps<img src=media/help.png height=16 style="padding-left:3px; margin-top:-2px;vertical-align:middle">
          <br><br>
        <div id="heat_proximal_pos" style="padding-left:0px; float: left; padding-right:55px; padding-bottom:15px;"></div>
        <div id="heat_distal_pos" style="float:left;"></div>
        <div id="heat_proximal_neg" style="padding-left:0px; float: left; padding-right:55px;"></div>
        <div id="heat_distal_neg" style="float:left;"></div>
      </div>

  </div>
</div>

<script>

  var trace1 = {
    mode: 'lines',
    type: 'scatter',
    fill: 'tozeroy',
    name: 'enhanced',
    line: {
      color: '#ff0000',
      width: 1
    }
  };

  var trace2 = {
    mode: 'lines',
    type: 'scatter',
    name: 'repressed',
    fill: 'tozeroy',
    line: {
      color: '#0000ff',
      width: 1
    }
  };

  var trace3 = {
    mode: 'lines',
    type: 'scatter',
    name: 'controls_up',
    line: {
      color: '#000000',
      width: 1
    },
    hoverinfo: 'none'
  };

  var trace4 = {
    mode: 'lines',
    type: 'scatter',
    name: 'controls_down',
    line: {
      color: '#000000',
      width: 1
    },
    hoverinfo: 'none'
  };

  var layout = {
    title: '',
    margin: {
      l: 65,
      r: 30,
      b: 30,
      t: 10
    },
    font: {
      family: 'Arial',
      size: 9,
      color: '#7f7f7f'
    },
    xaxis: {
      range: [-200, 200],
      title: 'distance from polyA site [nt]',
      titlefont: {
              family: 'Arial',
              size: 12,
              color: '#7f7f7f'
      },
      tickfont: {
              family: 'Arial',
              size: 11,
              color: '#7f7f7f'
      },
      zerolinecolor:'#cc0000',
      hoverformat: '+f',
    },
    yaxis: {
      range: [-100, 100],
      title: 'percentage of targets',
      titlefont: {
              family: 'Arial',
              size: 12,
              color: '#7f7f7f'
      },
      tickfont: {
              family: 'Arial',
              size: 11,
              color: '#7f7f7f'
      },
      exponentformat:'e',
      showexponent:'All',
      // https://github.com/mbostock/d3/wiki/Formatting#numbers
      hoverformat: '+.2f', // show mouse over values with 2 decimal precisions
    },
    width: 500,
    height: 150,
    paper_bgcolor: '#ffffff',
    plot_bgcolor: '#ffffff',
    hovermode: 'closest',
    showlegend: false,
};

function display_rnamap(div_name, site_type, pair_type, clip_index) {
  post_data = {};
  post_data["action"] = "rnamap";
  post_data["comps_id"] = comps_id;
  post_data["site_type"] = site_type;
  post_data["pair_type"] = pair_type;
  post_data["clip_index"] = clip_index;
  $.post('/expressrna_gw/index.py', post_data)
      .success(function(result) {
          data = $.parseJSON(result);
          data1 = jQuery.extend(true, {}, trace1);
          data2 = jQuery.extend(true, {}, trace2);
          data3 = jQuery.extend(true, {}, trace3);
          data4 = jQuery.extend(true, {}, trace4);
          data_layout = jQuery.extend(true, {}, layout);
          data1.x = data.x;
          data2.x = data.x;
          data3.x = data.x;
          data4.x = data.x;
          data1.y = data.vpos;
          data1.y = $.map( data1.y, function( n ) { return n * 100; });
          data2.y = data.vneg;
          data2.y = $.map( data2.y, function( n ) { return n * 100; });
          data3.y = data.cup;
          data3.y = $.map( data3.y, function( n ) { return n * 100; });
          data4.y = data.cdown;
          data4.y = $.map( data4.y, function( n ) { return n * 100; });
          lbl_pair_type = pair_type.replace("_", "-");
          if (site_type=="proximal") {
            //data_layout.title = ...
            $("#proximal_title").html("<b>proximal " + lbl_pair_type + "</b>, r=" + data.num_r + ", e=" + data.num_e + ", c=" + (data.num_cup+data.num_cdown));
          }
          else if (site_type=="distal") {
            //data_layout.title = ...
            $("#distal_title").html("<b>distal " + lbl_pair_type + "</b>, r=" + data.num_e + ", e=" + data.num_r + ", c=" + (data.num_cup+data.num_cdown));
          }
          else if (site_type=="s1") {
            //data_layout.title =
            $("#s1_title").html("<b>splice-site-1 " + lbl_pair_type + "</b>, r=" + data.num_e + ", e=" + data.num_r + ", c=" + (data.num_cup+data.num_cdown));
          }
          else if (site_type=="s2") {
            //data_layout.title = ...
            $("#s2_title").html("<b>splice-site-2 " + lbl_pair_type + "</b>, r=" + data.num_e + ", e=" + data.num_r + ", c=" + (data.num_cup+data.num_cdown));
          }
          data_layout.yaxis.range = [-Math.ceil(data.ymax*100), Math.ceil(data.ymax*100)];
          var plot_data = [data1, data2, data3, data4];
          Plotly.newPlot(div_name, plot_data, data_layout, {displaylogo: false, displayModeBar: false});
      })
      .error(function(){
          console.log('Error loading page');
  })
}

var track1_heat = {
  x: [],
  y: [],
  z: [],
  type: 'heatmap',
  colorscale: [],
  showscale: false,
  text : [['Text A', 'Text B', 'Text C']],
};

var layout_heat = {
  width: 450,
  height: 200,
  font: {
    family: 'Arial',
    size: 9,
    color: '#7f7f7f'
  },
  title: '<b>proximal same-exon</b> repressed',
  margin: {
    l: 100,
    r: 10,
    b: 15,
    t: 25
  },
  paper_bgcolor: '#ffffff',
  plot_bgcolor: '#ffffff',
  //hovermode: 'closest',
  annotations: [],
  xaxis: {
    ticks: '',
    side: 'bottom'
  },
  yaxis: {
    autotick : false,
    autosize: true,
    showticklabels: true,
    ticks: '',
    ticksuffix: ' ',
    tickfont: {
      family: 'Arial',
      size: 9,
      color: 'black'
    },
    showgrid : true,
  },
  xaxis: {
    showgrid : true,
    showticklabels: true,
    ticks: '',
    ticksuffix: ' ',
    tickfont: {
      family: 'Arial',
      size: 10,
      color: 'black'
    },

  }
};

function display_heat(div_name, site_type, pair_type, reg, clip_index) {
  post_data = {};
  post_data["action"] = "rnaheat";
  post_data["comps_id"] = comps_id;
  post_data["site_type"] = site_type;
  post_data["pair_type"] = pair_type;
  post_data["reg"] = reg;
  post_data["clip_index"] = clip_index;
  $.post('/expressrna_gw/index.py', post_data)
      .success(function(result) {
        data = $.parseJSON(result);
        data.data = $.parseJSON(data.data);
        plot_data = jQuery.extend(true, {}, track1_heat);
        data_layout = jQuery.extend(true, {}, layout_heat);
        plot_data.x = data.x;
        plot_data.y = data.ylabels.reverse();
        plot_data.z = data.data.reverse();
        lbl_pair_type = pair_type.replace("_", "-");
        if (site_type=="proximal") {
          if (reg=="pos") {
            data_layout.title = "<b>proximal " + lbl_pair_type + "</b> top 20 <b>enhanced</b> targets";
          } else {
            data_layout.title = "<b>proximal " + lbl_pair_type + "</b> top 20 <b>repressed</b> targets";
          }
        }
        else if (site_type=="distal") {
          if (reg=="pos") {
            data_layout.title = "<b>distal " + lbl_pair_type + "</b> top 20 <b>enhanced</b> targets";
          } else {
            data_layout.title = "<b>distal " + lbl_pair_type + "</b> top 20 <b>repressed</b> targets";
          }
        }
        // colors
        if (reg=="pos") {
          var colorscaleValue = [ [0, '#ffffff'], [1, '#FF6666'] ];
        } else {
          var colorscaleValue = [ [0, '#ffffff'], [1, '#6666FF'] ];
        }
        plot_data.colorscale = colorscaleValue;
        Plotly.newPlot(div_name, [plot_data], data_layout, {displaylogo: false, displayModeBar: false});
      })
      .error(function(){
          console.log('Error loading page');
  })
}

</script>

<script>

  hide_div_all();

  function hide_div_all() {
    $("#btn_es").css("background-color", "#e1e1e1");
    $("#btn_rna").css("background-color", "#e1e1e1");
    $("#btn_go").css("background-color", "#e1e1e1");
    $("#btn_atlas").css("background-color", "#e1e1e1");
    $("#btn_download").css("background-color", "#e1e1e1");
    $("#btn_target").css("background-color", "#e1e1e1");
    $("#btn_model").css("background-color", "#e1e1e1");
    $("#btn_splicing").css("background-color", "#e1e1e1");
    $("#div_es").hide();
    $("#div_target").hide();
    $("#div_rna").hide();
    $("#div_go").hide();
    $("#div_model").hide();
    $("#div_atlas").hide();
    $("#div_download").hide();
    $("#div_splicing").hide();
  }

  function hide_apatype_all() {
    $("#btn_same_exon").css("background-color", "#e1e1e1");
    $("#btn_composite_exon").css("background-color", "#e1e1e1");
    $("#btn_skipped_exon").css("background-color", "#e1e1e1");
    $("#btn_combined_exon").css("background-color", "#e1e1e1");
  }

  function open_div(name) {
    comps_module = name;
    hide_div_all();
    $("#div_" + comps_module).show();
    $("#btn_" + comps_module).css("background-color", "#c1c1c1");
    add_history("comps", {"comps_id":comps_id, "comps_module":comps_module}, "index.html?action=comps&comps_id="+comps_id+"&comps_module="+comps_module)
  }

  function open_pair_type(name) {
    pair_type = name;
    hide_apatype_all();
    $("#btn_" + name).css("background-color", "#c1c1c1");
    get_comps(comps_id);
  }

  function change_go(aspect) {
    go_aspect = aspect;
    display_go(comps_data.go);
  }

  function clip_selector_change() {
    clip_index = $("#clip_selector").prop('selectedIndex');
    get_comps(comps_id);
  }

  function get_comps(comps_id) {
    post_data = {};
    post_data["action"] = "get_comps";
    post_data["email"] = email;
    post_data["session"] = session;
    post_data["comps_id"] = comps_id;
    post_data["pair_type"] = pair_type;
    post_data["clip_index"] = clip_index;
    $.post('/expressrna_gw/index.py', post_data)
        .success(function(result) {
            data = $.parseJSON(result);
            $("#lbl_comps").html("<b>" + data.comps_name + "</b>" + " <font style='font-size:12px'>(site selection with <b>" + data.site_selection+"</b></font>)");

            clip_selector = '<form style="height: 5px;"><b>iCLIP:</b>: <select id=clip_selector style="width:300px;" onchange="clip_selector_change();">';
            for (var i=0; i<data.CLIP.length; i++)
            {
              sel = "";
              if (String(i)==clip_index) {
                sel = "selected";
              }
              clip_selector += '<option value="'+ i +'" ' + sel + '>' + data.CLIP[i] + '</option>'
              data.CLIP[i]
            }
            clip_selector += '</select></form>';
            $("#lbl_comps_notes").html(data.notes+"<br><br>" + clip_selector);

            comps_data = jQuery.extend(true, {}, data);
            display_experiments(data.control, data.test);
            display_go(comps_data.go);
            display_rnamap("proximal", "proximal", pair_type, clip_index);
            display_rnamap("distal", "distal", pair_type, clip_index);
            display_rnamap("s1", "s1", pair_type, clip_index);
            display_rnamap("s2", "s2", pair_type, clip_index);
            display_heat("heat_proximal_pos", "proximal", pair_type, "pos", clip_index);
            display_heat("heat_proximal_neg", "proximal", pair_type, "neg", clip_index);
            display_heat("heat_distal_pos", "distal", pair_type, "pos", clip_index);
            display_heat("heat_distal_neg", "distal", pair_type, "neg", clip_index);
            if (pair_type=="same_exon") {
              old_pair_type = "tandem";
            }
            if (pair_type=="composite_exon") {
              old_pair_type = "composite";
            }
            if (pair_type=="skipped_exon") {
              old_pair_type = "skipped";
            }
            $("#iframe_proximal").attr("src", "/rnamotifs2/" + comps_id + "_proximal_" + old_pair_type +"/rnamap/index.html?nocache="+nocache);
            $("#iframe_distal").attr("src", "/rnamotifs2/" + comps_id + "_distal"+ "_" + old_pair_type +"/rnamap/index.html?nocache="+nocache);
            $("#img_atlas").attr("src", "/comps/" + comps_id + "/" + comps_id + "_sites_per_gene.png?nocache="+nocache);
            $("#link_download1").attr("href", "comps/" + comps_id + "/" + comps_id + ".pairs_de.tab");
            $("#link_download2").attr("href", "comps/" + comps_id + "/" + comps_id + ".genes_de.tab");
            $("#link_download3").attr("href", "comps/" + comps_id + "/" + comps_id + ".expression_sites.tab");
            $("#link_download4").attr("href", "comps/" + comps_id + "/" + comps_id+ ".expression_genes.tab");
        })
        .error(function(){
            console.log('Error loading page');
    });
  }

function display_experiments_fill(data, label) {
  html = "<table class='es_table'>";
  html += "<tr style='background-color: #efefef;'><td colspan=8><div style='font-weight: 600; color: #777777; padding-top: 5px; padding-bottom: 5px; font-size: 12px;'>" + label + "</div></td></tr>";
  html += "<tr style='background-color: #dfdfdf;'>";

  help_id = "Control experiment number in the analysis (c1, c2, ...) or test experiment number in the analysis (t1, t2, ...).";
  help_aligned = "Percentage of uniquely aligned reads to the reference genome.";
  help_identifier = "The identifier links the experiment to the library. The identification is composed of: library_id (e.g. 20171212_data) + experiment_id (e.g. e1). This identified uniquely maps the experiment to the data.";

  html += "<td><font color=gray><b>Number</b></font><font class='btn' title='" + help_id + "'><img src=media/help.png style='height: 15px; margin-top:-2px;vertical-align:middle; padding-left: 3px;'></font></td>";
  html += "<td><font color=gray><b>Identifier</b></font><font class='btn' title='" + help_identifier + "'><img src=media/help.png style='height: 15px; margin-top:-2px;vertical-align:middle; padding-left: 3px;'></font></td>";
  html += "<td><font color=gray><b>Genome</b></font></td>";
  html += "<td><font color=gray><b>Tissue</b></font></td>";
  html += "<td><font color=gray><b>Condition</b></font></td>";
  html += "<td><font color=gray><b>Reads [M]</b></font></td>";
  html += "<td><font color=gray><b>Aligned [%]</b></font><font class='btn' title='" + help_aligned+ "'><img src=media/help.png style='height: 15px; margin-top:-2px;vertical-align:middle; padding-left: 3px;'></font></td>";
  html += "<td>Downloads</td>";
  html += "</tr>";
  for (var i=0; i<data.length; i++)
  {
    html += "<tr style='font-weight: 300;'>";
    html += "<td class=nowrap align=center>" + data[i].cid + "</td><td class=notes>" + data[i].lib_id + "_e" + data[i].exp_id + "</td><td class=nowrap>" + data[i].map_to + "</td><td class=nowrap>" + data[i].tissue + "</td><td class=nowrap>" + data[i].condition + "</td><td class=nowrap align=center>" + data[i].stats[0] + " M</td><td class=nowrap align=center>" + data[i].stats[1] + "</td>";
    lib_id = data[i].lib_id;
    exp_id = data[i].exp_id;
    fastq_link = "https://expressrna.org/share/data/" + lib_id + "/e" + exp_id + "/" + lib_id + "_e" + exp_id + ".fastq.gz";
    bam_link = "https://expressrna.org/share/data/" + lib_id + "/e" + exp_id + "/m1/" + lib_id + "_e" + exp_id + "_m1.bam";
    html += "<td><a href=" + fastq_link + ">FastQ</a> | <a href=" + bam_link + ">BAM</a></td>";
    html += "</tr>";
  }
  html += "</table>";
  return html;
}

function display_experiments(data_control, data_test) {
  html = "<center>";
  html += "Information about the experiments included in the comparison<br><br>"
  html += display_experiments_fill(data_control, "Control experiments");
  html += "<br>";
  html += display_experiments_fill(data_test, "Test experiments");
  $("#div_es").html(html);
  tippy('.btn', {theme: 'light', interactive: true});
}

function display_go_fill(data) {
  html = "<table class='go_table'>";
  html += "<tr style='background-color: #dfdfdf;'>";
  html += "<td><font color=gray><b>GO term</b></font></td><td><font color=gray><b>GO name</b></font></td><td><font color=gray><b>GO genes</b></font></td><td><font color=gray><b>Depth</b></font></td><td><font color=gray><b>p-value</b></font></td><td><font color=gray><b>FDR</b></font></td><td><font color=gray><b>Red [%]</b></font></td><td><font color=gray><b>Enriched genes</b></font></td>";
  html += "</tr>";
  for (var i=0; i<Math.min(data.length, 10); i++)
  {
    data[i][0] = data[i][0].toFixed(5); // p-value
    if (data[i][0]>0.1) {
      continue;
    }
    data[i][6] = data[i][6].toFixed(5); // fdr
    data[i][4] = data[i][4].split(",").join(", ");
    html += "<tr>";
    html += "<td class=nowrap align=center>" + data[i][1] + "</td><td class=notes>" + data[i][3] + "</td><td class=nowrap align=center>" + data[i][5] + "</td><td class=nowrap align=center>" + data[i][2] + "</td><td class=nowrap align=center>" + data[i][0] + "</td><td class=nowrap align=center>" + data[i][6] + "</td><td class=nowrap align=center>" + data[i][7] + "</td><td class=genes>" + data[i][4] + "</td>";
    html += "</tr>";
  }
  html += "</table>";
  return html
}

function display_go(data) {
  data = jQuery.extend(true, {}, data); // make deep copy, because we manipulate the data (float numbers etc), and load different go aspects several times (user switch)
  old_pair_type = {"same_exon":"tandem", "composite_exon":"composite", "skipped_exon":"skipped", "combined_exon":"all"}[pair_type];

  html = "<center>";
  html += "GO enrichment analysis (showing only top 10 terms with p-value<0.1)<a href=\"javascript:load_help('apaExpress_go.html');\"><img src=media/help.png height=16 style='padding-left:3px; margin-top:-2px;vertical-align:middle'></a><br>"

  html+= "<table border=0 class=gotype_menu><tr>";
  html+= "<td id='btn_go_P' onclick=\"javascript:change_go('P');\">biological process</td><td style='padding-left: 0px; padding-right: 0px; width:5px; background-color: transparent !important; cursor:default;'></td>";
  html+= "<td id='btn_go_C' onclick=\"javascript:change_go('C');\">cellular component</td>";
  html+= "</tr></table><br>";

  html += "<b>Repressed genes</b><img src=media/icon_download_small.png height=10 style='padding-left:5px; padding-right:3px; margin-top:-2px;vertical-align:middle'>";
  html += "<a href='/comps/" + comps_id + "/rnamap/go_repressed_" + old_pair_type + ".tab' target=_download download>Download</a><br>";
  html += display_go_fill(data["repressed_"+old_pair_type+"_"+go_aspect]);
  html += "<br>";

  html += "<b>Enhanced genes</b><img src=media/icon_download_small.png height=10 style='padding-left:5px; padding-right:3px; margin-top:-2px;vertical-align:middle'>";
  html += "<a href='/comps/" + comps_id + "/rnamap/go_enhanced_" + old_pair_type + ".tab' target=_download download>Download</a><br>";
  html += display_go_fill(data["enhanced_"+old_pair_type+"_"+go_aspect]);
  html += "<br>";

  html += "<b>Repressed proximal (protein bound) genes</b><img src=media/icon_download_small.png height=10 style='padding-left:5px; padding-right:3px; margin-top:-2px;vertical-align:middle'>";
  html += "<a href='/comps/" + comps_id + "/rnamap/go_repressed_proximal_" + old_pair_type + ".tab' target=_download download>Download</a><br>";
  html += display_go_fill(data["repressed_proximal_"+old_pair_type+"_"+go_aspect]);
  html += "<br>";

  html += "<b>Enhanced proximal (protein bound) genes</b><img src=media/icon_download_small.png height=10 style='padding-left:5px; padding-right:3px; margin-top:-2px;vertical-align:middle'>";
  html += "<a href='/comps/" + comps_id + "/rnamap/go_enhanced_proximal_" + old_pair_type + ".tab' target=_download download>Download</a><br>";
  html += display_go_fill(data["enhanced_proximal_"+old_pair_type+"_"+go_aspect]);
  html += "<br>";

  html += "<b>Repressed distal (protein bound) genes</b><img src=media/icon_download_small.png height=10 style='padding-left:5px; padding-right:3px; margin-top:-2px;vertical-align:middle'>";
  html += "<a href='/comps/" + comps_id + "/rnamap/go_repressed_distal_" + old_pair_type + ".tab' target=_download download>Download</a><br>";
  html += display_go_fill(data["repressed_distal_"+old_pair_type+"_"+go_aspect]);
  html += "<br>";

  html += "<b>Enhanced distal (protein bound) genes</b><img src=media/icon_download_small.png height=10 style='padding-left:5px; padding-right:3px; margin-top:-2px;vertical-align:middle'>";
  html += "<a href='/comps/" + comps_id + "/rnamap/go_enhanced_distal_" + old_pair_type + ".tab' target=_download download>Download</a><br>";
  html += display_go_fill(data["enhanced_distal_"+old_pair_type+"_"+go_aspect]);
  html += "<br>";

  $("#div_go").html(html);

  // adjust buttons
  $("#btn_go_P").css("background-color", "#e1e1e1");
  $("#btn_go_C").css("background-color", "#e1e1e1");
  $("#btn_go_" + go_aspect).css("background-color", "#c1c1c1");

}

  open_div(comps_module);
  open_pair_type("same_exon");

</script>

<script>
  tippy('.btn', {theme: 'light', interactive: true});
</script>
